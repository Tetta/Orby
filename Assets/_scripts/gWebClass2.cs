using UnityEngine;
using System.Collections;

public class gWebClass2 : MonoBehaviour {
	// Use this for initialization
	public GameObject holder;
	public GameObject web;
	public GameObject web2;
	public GameObject chainPrefab;
	public GameObject pointB;
	public Vector3 pointBAchor;
	private int globalCounter = 0;
	//private int maxChainCount = 40;
	private int maxChainCount = 40;
	private int chainCount = 0;
	private float  chainLength = 78F;
	private GameObject[] chain;
	private Vector2[] v;
	private float maxDiffC;
	private Vector2 diff;
	private string webState = "";
	private float diffX;
	private float diffY;
	private float chainPositionZ = 1;
	private HingeJoint2D jointWeb; 
	private int normalChainCount = 20;
	private GameObject berry;

	void Start () {
		berry = GameObject.Find("berry");
		v = new Vector2[100];
		//blocks = GameObject.FindGameObjectsWithTag("block"); 
		chain = new GameObject[100];
		maxDiffC = chainLength * maxChainCount;
		jointWeb = web.GetComponent<HingeJoint2D> ();
		if (pointB != null) { 
			diff = pointB.transform.position + pointBAchor - web.transform.position;
			float pointBDiffC = Mathf.Sqrt(diff.x * diff.x + diff.y * diff.y);
			diffX = maxDiffC / pointBDiffC * diff.x / maxChainCount;
			diffY = maxDiffC / pointBDiffC * diff.y / maxChainCount;
			webState = "creatingWeb";
			while (webState == "creatingWeb") {
				createWeb(pointB.transform.position, pointBAchor);

				int i = chainCount;
				//chain[i].rigidbody2D.fixedAngle = true;
				if (pointB.collider2D.OverlapPoint(chain[1].transform.position + new Vector3(diffX, diffY, 0))) {
					chainCount = i;
					HingeJoint2D[] jointChain = chain[1].GetComponents<HingeJoint2D> ();
					foreach (HingeJoint2D item in jointChain) {
						item.connectedBody = pointB.rigidbody2D;
						item.connectedAnchor = pointBAchor;
						item.enabled = true;	

					}
					//jointChain.useLimits = false;
					//i = maxChainCount / 2;
					webState = "enableWeb";

				}
			}
		}
	}
	
	// Update is called once per frame
	void Update () {
		//
		/*
		V3=V2-V1;
		V2.x = V3.x*cos(a) - V3.y*sin(a);
		V2.y = V3.x*sin(a) + V3.y*cos(a);
		V2=V2+V1;
		*/
		if (webState == "creatingWeb") {
			for (int j = 0; j < 8; j++) {
				if (chainCount < maxChainCount && webState == "creatingWeb") {
					createWeb(berry.transform.position, new Vector3(0, 0, 0));
				}
			}
		}

		/*
		if (webState == "collisionOrby1") {
			HingeJoint2D jointChain = chain[1].GetComponent<HingeJoint2D> ();

			jointChain.useLimits = false;
			//jointChain.limits = new JointAngleLimits2D { min = 180, max = 0};
			jointChain.connectedBody = orby.rigidbody2D;
			jointChain.connectedAnchor = orby.transform.position - chain[1].transform.position;
			//jointChain.connectedAnchor = new Vector2(0, 0);
			jointChain.enabled = true;	
			webState = "afterCollisionOrby";
		}
		*/
		if (webState == "afterCollisionOrby") {
			HingeJoint2D jointWeb = web.GetComponent<HingeJoint2D> ();
			for (int j = 0; j < 2; j++) {
				if (normalChainCount < chainCount) {
					Destroy(chain[chainCount], 0);

					for (int y = 1; y <= chainCount; y++) {
						chain[y].transform.position =  new Vector3(web.transform.position.x + diffX * (chainCount - y), web.transform.position.y + diffY * (chainCount - y), chainPositionZ);
					}
					//orby.transform.position =  new Vector3(web.transform.position.x + diffX * chainCount, web.transform.position.y + diffY * chainCount, chainPositionZ);
					jointWeb.connectedBody = chain[chainCount - 1].rigidbody2D;
					chainCount--;
				} else {
					webState = "enableWeb";
				}
			}

		}

		if (webState == "noCollisions" || webState == "destroyingWeb" || webState == "collisionBlock") {
			for (int j = 0; j < 2; j++) {
				if (chainCount > 0) {
					Destroy(chain[globalCounter], 0);
					chainCount--;
					globalCounter ++;
				
				} else {
					webState = "";
				}
			}
			holder.GetComponent<LineRenderer>().SetVertexCount (chainCount);
			for(int i = 0; i < chainCount; i++)
				holder.GetComponent<LineRenderer>().SetPosition (i, chain[i + globalCounter].transform.position);


		}
		if (webState == "enableWeb" || webState == "creatingWeb") {
			holder.GetComponent<LineRenderer>().SetVertexCount (chainCount);
			for(int i = 1; i <= chainCount; i++)
				holder.GetComponent<LineRenderer>().SetPosition (i - 1, chain[i].transform.position);
		}

	}

	void FixedUpdate () {
		if (webState == "enableWeb" && Time.frameCount % 10 == 1  && false) {
			for (int j = chainCount - 1; j >= 1; j--) {
				HingeJoint2D[] jointChain = chain[j].GetComponents<HingeJoint2D> ();
				//chain[j].transform.hasChanged = false;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         chain[j].rigidbody2D.velocity = v[j];
				//Debug.Log (jointChain[0].jointSpeed);
				//Debug.Log (chain[j].rigidbody2D.velocity.y);
				//chain[j].rigidbody2D.isKinematic = false;
				//Debug.Log (chain[j].rigidbody2D.velocity.y);
				//chain[j].rigidbody2D.velocity = v[j];
			}
			//Debug.Log (jointChain2[0].jointSpeed);
			
		}	
		if (webState == "enableWeb" && Time.frameCount % 100 == 0 && false) {
			//Debug.Log ("ww");
			for (int j = chainCount - 1; j >= 1; j--) {
				HingeJoint2D[] jointChain = chain[j].GetComponents<HingeJoint2D> ();
				
				Vector3 V1 = new Vector3(0.00F, -0.13F, 0);
				Vector3 V2 = new Vector3(0, 0, 0);
				float deg = -jointChain[0].jointAngle;
				V2.x = (V1.x*Mathf.Cos(deg * Mathf.Deg2Rad) - V1.y*Mathf.Sin(deg * Mathf.Deg2Rad)) * 2.66F;
				V2.y = (V1.x*Mathf.Sin(deg * Mathf.Deg2Rad) + V1.y*Mathf.Cos(deg * Mathf.Deg2Rad)) * 6;
				
				//Debug.Log (V2.x);
				//Debug.Log (V2.y);
				//chain[j].rigidbody2D.isKinematic = true;
				//chain[j].transform.localPosition = chain[j + 1].transform.localPosition + V2;
				//Debug.Log (chain[j].rigidbody2D.velocity.y);
				v[j] = chain[j].rigidbody2D.velocity;
				Debug.Log (jointChain[0].jointSpeed);
				//Debug.Log (v[j].y);
				//chain[j].transform.localRotation = chain[j].transform.localRotation;
				//chain[j].isStatic = chain[j].gameObject;
				chain[j].transform.hasChanged = false;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         chain[j].rigidbody2D.velocity = v[j];
				//Debug.Log (chain[j].rigidbody2D.velocity.y);
				//chain[j].rigidbody2D.centerOfMass = new Vector2(0, 0);
				//chain[j].rigidbody2D.AddRelativeForce(chain[j + 1].transform.localPosition  + V2, );
				//if (j == 20) chain[j].transform.localPosition = new Vector3(0, -0.45F, 1);
				//else chain[j].transform.localPosition = chain[j + 1].transform.localPosition - new Vector3(0, 0.39F, 1);
				//Debug.Log(jointChain[0].referenceAngle);
				//Debug.Log(jointChain[0].jointAngle);
				//chain[j].rigidbody2D.velocity = berry.rigidbody2D.velocity;
			}
		}
	}

	void createWeb (Vector3 pointBPosition, Vector3 pointBAchor) {
		chainCount ++; 
		int i = chainCount;
		Vector3 pos = new Vector3(transform.position.x, transform.position.y, 1);
		chain[i] = Instantiate(chainPrefab, pos, Quaternion.identity) as GameObject;
		chain[i].GetComponent<SpriteRenderer> ().sortingOrder = i;
		Vector3 relative = transform.InverseTransformPoint(pointBPosition + pointBAchor);
		float angle = Mathf.Atan2(relative.x, relative.y) * Mathf.Rad2Deg;
		chain[i].transform.Rotate(0, 0, 180 - angle);
		chain[i].name = "chain " + i;
		chain[i].transform.parent = holder.transform;
		//chain[i].rigidbody.constraints = RigidbodyConstraints.FreezePositionZ;
		if (i == 1) {
			jointWeb.connectedBody = chain[i].rigidbody2D;
			jointWeb.enabled = true;
			
			//chainClass script = chain[i].GetComponent <chainClass>();
		} else {
			if (!berry.collider2D.OverlapPoint(chain[1].transform.position)) {
				for (int y = 1; y <= i; y++) {
					chain[y].transform.position = new Vector3(web.transform.position.x + diffX * (i - y), web.transform.position.y + diffY * (i - y), chainPositionZ);
				}
			}
			HingeJoint2D[] joint = chain[i].GetComponents<HingeJoint2D> ();
			foreach (HingeJoint2D item in joint) {
				item.connectedBody = chain[i - 1].rigidbody2D;
				item.enabled = true;
	
				
			}
			jointWeb.connectedBody = chain[i].rigidbody2D;
			if (berry.collider2D.OverlapPoint(chain[1].transform.position) && i >= 20) {
				HingeJoint2D[] jointChain = chain[1].GetComponents<HingeJoint2D> ();
				Debug.Log(chain[1].name);
				foreach (HingeJoint2D item in joint) {

					item.connectedAnchor = berry.transform.InverseTransformPoint(chain[1].transform.position);
					
					item.connectedBody = berry.rigidbody2D;
					//jointChain.connectedAnchor = new Vector2(0, 0);
					item.enabled = true;					
					
				}
				//jointChain.useLimits = false;
				//jointChain.limits = new JointAngleLimits2D { min = 180, max = 0};
	
				webState = "afterCollisionOrby";

				//diff = orby.transform.position - web.transform.position;
				//float orbyDiffC = Mathf.Sqrt(diff.x * diff.x + diff.y * diff.y);
				//diffX = maxDiffC / orbyDiffC * diff.x / maxChainCount;
				//diffY = maxDiffC / orbyDiffC * diff.y / maxChainCount;

				//chain[99] = Instantiate(web2, chain[1].transform.position, Quaternion.identity) as GameObject;
				//chain[99].transform.parent = orby.transform;
				//chain[99].transform.Rotate(0, 0, - angle);
				//webState = "collisionOrby";
				//Debug.Log ("webState = collisionOrby");
				//Debug.Log (Time.time + ": chainCount = " + chainCount);
			} 
		}
		if (chainCount == maxChainCount) {
			webState = "noCollisions";
			globalCounter = 1;
		}

	}
	
	void OnMouseDown () {
		//Debug.Log("OnMouseDown");
		if (webState == "") {
			//i = 0;
			diff = berry.transform.position - web.transform.position;
			float orbyDiffC = Mathf.Sqrt(diff.x * diff.x + diff.y * diff.y);
			diffX = maxDiffC / orbyDiffC * diff.x / maxChainCount;
			diffY = maxDiffC / orbyDiffC * diff.y / maxChainCount;
			webState = "creatingWeb";
		}
		if (webState == "enableWeb") {
			webState = "destroyingWeb";
			globalCounter = 1;
		}
	}


}
